# 文件服务

## 基础知识
* 对于一个生产环境而言，配置和启用文件服务器是很有必要的，把重要的数据都集中存储和管理，这样的做法显然要比分别存储在不同的地方要可靠的多。
* 在Linux下常用的方式有3种，分别是：NFS服务器，Samba服务器，ftp服务器。
* ftp的客户可以来自于任何平台，只要你拥有ftp的shell或相对应的ftp客户端即可。
* Samba专门针对windows用户，但是Linux用户也可以使用。
* NFS则是针对Linux/Unix用户的。
#### 一个简单的表格对比如下：
|名称|客户端|常用范围|服务端口|
|---|:----:|:------:|-------|
|FTP|Windows/Linux/Unix/MacOS….|发布网站，文件共享|TCP/21、22、随机|
|Samba|Windows/Linux/Unix|文件共享（网上邻居）|TCP/445,TCP/139|
|NFS|Linux/Unix|发布网站，文件共享|TCP/2049|

### NFS介绍
* NFS是SUN Microsystem公司开发的网络文件系统，它是一种基于远程过程调用（RPC）的分布式文件系统架构。是Linux/Unix之间共享文件的主力军，其吞吐能力要好于samba。

* NFS全称是network file system，NFS允许一个系统在网络上与他人共享目录和文件。通过使用NFS，用户和程序可以像访问本地文件一样访问远端系统上的文件。

* 假如有三台机器A, B, C，它们需要访问同一个目录，目录中都是图片，传统的做法是把这些图片分别放到A, B, C. 但是使用NFS只需要放到A上，然后A共享给B和C即可。访问的时候，B和C是通过网络的方式去访问A上的那个目录的。

## NFS概念
* RPC（Remote Procedure Call Protocol远程过程调用协议）：
简单的说是函数调用（远程主机上的函数） 一部分功能由本地程序完成 另一部分功能由远程主机上的函数完成。客户端挂载了nfs服务器的文件系统时，进行一些操作，但是这些操作服务端如何知道呢？？这可是在内核级别上实现协议。RPC就解决了这个问题，它会将客户端的操作的函数调用发送到服务器端，由服务器端执行这些函数调用。

* idmapd：
想想这种情形，nfs客户端在挂载文件系统以后，在本地以某用户的身份创建了一个文件，在服务器端这个文件的属主和属组是哪个用户呢？早期是通过NIS（Network Information Services网络信息服务）来解决这个问题的，但是在传输账号和密码时，使用的是明文传输，现在使用LDAP+clbbler来实现的。但是，NFS使用的是idmapd这个服务，有rpc提供，将所有的用户后映射为nfsnobody，但是在访问的时候，还是以本地UID对应的本地用户来使用的。

* mounted:
NFS是通过什么来控制那些客户端可以访问，那些不可以访问的呢？NFS只支持通过IP来控制客户端，而这个功能是由守护进程mounted来实现的，它监听的端口是半随机的。所谓的半随机指的是，这个随机端口是由rpc服务来决定的，而rpc是通过随机的方式。作用等等同于小区大门保安的作用。

## NFS请求过程
* 在CentOS6.5中，NFS服务端监听在tcp和udp的2049端口，服务名是nfs、pc监听于tcp和udp的111号端口，服务名是portmapper。

* 请求过程：当客户端试这去挂载使用nfs共享的文件系统是，客户端首先回去与postmapper(tcp/111)端口去注册使用，此时postmapper会随机分配一个端口给mounted,然后mounted这个守护进程会来验证客户端的合法性，验证通过后，会把请求交给nfs服务，客户端此时可以挂载使用了，用户在创建文件时，会使用到idmapd的守护进程来映射属主。其实idmapd也是有rpc服务提供的，只不过在这里，nfs服务使用到用户映射的功能时，会自动的去调用此守护进程。

## NFS配置
* CentOS7在默认情况下支持NFSV4，并在该版本不可用的情况下自动回退到VFSv3和NFSv2。NFSv4使用TCP协议与服务器进行通信，较早的版本使用TCP或者UDP。
* NFS服务器安装要求安装nfs-utils软件包。此软件包提供了使用NFS将目录共享到客户端必须的所有使用程序。用于NFS服务器配置共享目录的文件为/etc/exports。

        这个文件的书写格式如下：
        共享目录    客户端  （选项1，选项2） 客户端（选项1，选项2） …  
        示例：
        /mydata   172.16.0.0/16（ro,async,no_root_squash)   www.example.com（ro）

        主机IP地址：例如 192.168.1.10
        网络地址：例如 172.16.0.0/24
        域名表示：例如 www.example.com（指定主机），*.example.com（对应域名下的所有主机）
        *:表示所有的主机

* 常见的选项

|选项|解释|
|:---:|:----:|
|rw|这个选项允许 NFS 客户机进行读/写访问。缺省选项是只读的。|
|secure|这个选项是缺省选项，它使用了 1024 以下的 TCP/IP 端口实现 NFS 的连接。指定 insecure 可以禁用这个选项。|
|async|异步存储（所有的客户端操作先在内存中缓存，等待cpu空闲的时候写入磁盘）。这个选项可以改进性能，但是如果没有完全关闭 NFS 守护进程就重新启动了 NFS 服务器，这也可能会造成数据丢失。与之相反的是syns，是同步写入磁盘。|
|no_wdelay|这个选项关闭写延时。如果设置了 async，那么 NFS 就会忽略这个选项。|
|nohide|如果将一个目录挂载到另外一个目录之上，那么原来的目录通常就被隐藏起来或看起来像空的一样。要禁用这种行为，需启用 hide 选项。|
|no_subtree_check|这个选项关闭子树检查，子树检查会执行一些不想忽略的安全性检查。缺省选项是启用子树检查。|
|no_auth_nlm|这个选项也可以作为 insecure_locks 指定，它告诉 NFS 守护进程不要对加锁请求进行认证。如果关心安全性问题，就要避免使用这个选项。缺省选项是 auth_nlm 或 secure_locks。|
|mp (mountpoint=path)|通过显式地声明这个选项，NFS 要求挂载所导出的目录。|
|fsid=num|这个选项通常都在 NFS 故障恢复的情况中使用。如果希望实现 NFS 的故障恢复，请参考 NFS 文档|

* 用户映射的选项

|选项|解释|
|:---:|:----:|
|root_squash|这个选项不允许 root 用户访问挂载上来的 NFS 卷。|
|no_root_squash|这个选项允许 root 用户访问挂载上来的 NFS 卷。|
|all_squash|这个选项对于公共访问的 NFS 卷来说非常有用，它会限制所有的 UID 和 GID，只使用匿名用户。缺省设置是 no_all_squash。|
|anonuid 和 anongid|这两个选项将匿名 UID 和 GID 修改成特定用户和组帐号。|

* 防火墙设置
* 启动和停止NFS服务

