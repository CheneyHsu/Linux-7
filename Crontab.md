# 自动化任务
基础知识
实际的系统管理中，我们往往需要定时去执行一些脚本或者程序，这些事情都是发生在未来的时间呢，由于种种原因，我们不可能一直守着主机在旁边等着时间达到，然后去执行。
这个时候我们可以使用系统中的自动化定时任务这个机制，定制精准的未来时间去执行某项任务。
At（单次执行！！）
	Linux系统用户用来计划将来任务之一的解决方案是at。这不是单机工具，而是一个系统守护进程atd。它有一组命令工具可与守护系统at、atq等等进行交互。在默认的Linux安装过程中，atd守护进程将自动安装和启用。Atd守护进程可以在at软件包中找到。
	用户root可以使用命令行工具at为atd守护进程的作业排队。Atd守护进程提供了阿到z共26个队列，作业按字母顺序排列，队列越后，系统优先级越低。
计划作业：
使用at《timespec》可以计划新作业，at随后会读取从stdin执行命令。对于较大的命令以及错别字敏感命令，使用来自脚本文件（例如：at now+5min < script.sh）的输入重定向比在终端窗口手动输入所有命令要简单。手动输入命令时，您可以按Ctrl+D来完成输入。
	《timespec》允许许多强大的组合，用户可以自由地来说明应运行作业的准确时间。通常，这些组合以时间（05:00pm、13:59）开头，后面接一个可选日期或将来的天数。
	实例如下：
		1：now +10min
		2:  noon +4days
		3:  7pm aug 3 2015
创建作业：
[root@localhost ~]# at 5pm aug 3 2016
[root@localhost ~]# at 5pm +4days
at> /root/test.sh
at> <EOT>
job 3 at Tue Dec 15 17:00:00 2015
检查作业：
	获得用户待处理作业的概述，可以使用命令atq或者别名 at –l
[root@localhost ~]# at -l
1	Wed Aug  3 17:00:00 2016 a root
2	Wed Aug  3 17:00:00 2016 a root
输出的4个列如下：
1：作业编号，第一行为1
2：该作业执行时间和日期，第一行为2016年8月3日17:00:00
3：作业所在队列，a在第一行
4：作业所有者
备注：普通非特权用户只能查看自己的作业，root用户可以查看和管理所有作业
删除作业：
	删除作业可以先使用atq 或者 at –l来查看作业，当作业不需要的时候，可以使用atrm 《JOBNUMBER》来删除。
[root@localhost ~]# atrm <JOBNUMBER>
小结：
	At自动化仅仅是执行一次，如果我们需要周期反复的执行，那么你有2种选择，一个是使用at不断的重复添加，另一个是使用cron计划周期性作业
Cron计划周期性作业
使用at后，理论上，我们可以在执行一项作业之后，重新提交作业，来实现周期性作业。实际上，这样对管理员来说将大大增加工作量，并且大量人工操作使得出错几率非常高。
	Crond守护进程是linux系统自带的周期性作业调度。并且默认安装和默认开启。Crond是由多个配置文件和系统范围内的文件控制的，每个用户对应一个配置文件。这些配置文件使用户和管理员拥有细微的控制权，可以控制应执行周期性作业的确切时间。Crond守护进程作为cronie软件包的一部分。
	如果从cron作业运行命令向未重定向的stdout或者stderr生成任何输出，则crond守护进程将尝试使用系统中配置的邮件服务器将该输出通过电子邮件发送给拥有该作业的用户。
计划作业常用指令：
命令	用途
Crontab –l	列出当前用户的计划任务
Crontab –r	删除当前用户的所有计划任务
Crontab –e	编辑当前用户的计划任务
Crontab <filename>	删除所有作业，并替换为从<filename>读取的作业。如果为执行任何文件，则将使用stdin
创建作业：
使用命令crontab –e 将开启编辑器模式进行作业填写，默认是当前用户作业，如果要创建其他用户作业，可以使用 crontab –u xcl –e，使用-u参数指定用户。
#crontab –e
56 6 * * * /home/sysadmin/check/bin/Upload.sh > /dev/null 2>&1
crontab文件的含义：
用户所建立的crontab文件中，每一行都代表一项任务，每行的每个字段代表一项设置，它的格式共分为六个字段，前五段是时间设定段，第六段是要执行的命令段，格式如下：
minute   hour   day   month   week   command
其中：
minute： 表示分钟，可以是从0到59之间的任何整数。
hour：表示小时，可以是从0到23之间的任何整数。
day：表示日期，可以是从1到31之间的任何整数。
month：表示月份，可以是从1到12之间的任何整数。
week：表示星期几，可以是从0到7之间的任何整数，这里的0或7代表星期日。
command：要执行的命令，可以是系统命令，也可以是自己编写的脚本文件。
 
可以有如下书写方法：
*表示无关紧要 /始终
x-y 表示范围，x 到 y （含）
x，y 表示列表，例如：分钟可以写成 5,10-13,17 表示作业应当在每小时过去5分钟，10分钟，11分钟，12分钟，13分钟和17分钟后运行。
*/x 表示x的时间间隔，例如分钟列表的*/7表示没7分钟运行一次作业。
Crontab权限：
文件：/etc/cron.deny
说明：该文件中所列用户不允许使用crontab命令
文件：/etc/cron.allow
说明：该文件中所列用户允许使用crontab命令
文件：/var/spool/cron/
说明：所有用户crontab文件存放的目录,以用户名命名

Crontab实例
实例1：每1分钟执行一次command
命令：* * * * * command
实例2：每小时的第3和第15分钟执行
命令：3,15 * * * * command
实例3：在上午8点到11点的第3和第15分钟执行
命令：3,15 8-11 * * * command
实例4：每隔两天的上午8点到11点的第3和第15分钟执行
命令：3,15 8-11 */2 * * command
实例5：一月一号的4点重启smb 
命令：0 4 1 jan * /etc/init.d/smb restart
说明：
run-parts这个参数了，如果去掉这个参数的话，后面就可以写要运行的某个脚本名，而不是目录名了

使用注意事项
1. 注意环境变量问题
有时我们创建了一个crontab，但是这个任务却无法自动执行，而手动执行这个任务却没有问题，这种情况一般是由于在crontab文件中没有配置环境变量引起的。
在 crontab文件中定义多个调度任务时，需要特别注意的一个问题就是环境变量的设置，因为我们手动执行某个任务时，是在当前shell环境下进行的，程 序当然能找到环境变量，而系统自动执行任务调度时，是不会加载任何环境变量的，因此，就需要在crontab文件中指定任务运行所需的所有环境变量，这 样，系统执行任务调度时就没有问题了。
不要假定cron知道所需要的特殊环境，它其实并不知道。所以你要保证在shelll脚本中提供所有必要的路径和环境变量，除了一些自动设置的全局变量。所以注意如下3点：
1）脚本中涉及文件路径时写全局路径；
2）脚本执行要用到java或其他环境变量时，通过source命令引入环境变量，如：
cat start_cbp.sh
#!/bin/sh
source /etc/profile
export RUN_CONF=/home/d139/conf/platform/cbp/cbp_jboss.conf
/usr/local/jboss-4.0.5/bin/run.sh -c mev &
3）当手动执行脚本OK，但是crontab死活不执行时。这时必须大胆怀疑是环境变量惹的祸，并可以尝试在crontab中直接引入环境变量解决问题。如：
0 * * * * . /etc/profile;/bin/sh /var/www/java/audit_no_count/bin/restart_audit.sh
2. 注意清理系统用户的邮件日志
每条任务调度执行完毕，系统都会将任务输出信息通过电子邮件的形式发送给当前系统用户，这样日积月累，日志信息会非常大，可能会影响系统的正常运行，因此，将每条任务进行重定向处理非常重要。
例如，可以在crontab文件中设置如下形式，忽略日志输出：
0 */3 * * * /usr/local/apache2/apachectl restart >/dev/null 2>&1
“/dev/null 2>&1”表示先将标准输出重定向到/dev/null，然后将标准错误重定向到标准输出，由于标准输出已经重定向到了/dev/null，因此标准错误也会重定向到/dev/null，这样日志输出问题就解决了。
3. 系统级任务调度与用户级任务调度
系 统级任务调度主要完成系统的一些维护操作，用户级任务调度主要完成用户自定义的一些任务，可以将用户级任务调度放到系统级任务调度来完成（不建议这么 做），但是反过来却不行，root用户的任务调度操作可以通过“crontab –uroot –e”来设置，也可以将调度任务直接写入/etc /crontab文件，需要注意的是，如果要定义一个定时重启系统的任务，就必须将任务放到/etc/crontab文件，即使在root用户下创建一个 定时重启系统的任务也是无效的。
4. 其他注意事项
新创建的cron job，不会马上执行，至少要过2分钟才执行。如果重启cron则马上执行。
当crontab突然失效时，可以尝试/etc/init.d/crond restart解决问题。或者查看日志看某个job有没有执行/报错tail -f /var/log/cron。
千万别乱运行crontab -r。它从Crontab目录（/var/spool/cron）中删除用户的Crontab文件。删除了该用户的所有crontab都没了。
在crontab中%是有特殊含义的，表示换行的意思。如果要用的话必须进行转义\%，如经常用的date ‘+%Y%m%d’在crontab里是不会执行的，应该换成date ‘+\%Y\%m\%d’。

总结
Crontab是生产中常用的自动化周期性作业指定的方式，比如我们写了很多系统数据采集脚本，都是通过crontab来进行自动化执行的，还有统计每天的交易量，然后发邮件给管理员做统计，这些需要自动化的，周期性的执行任务，你可以放心的交给crond来执行！

